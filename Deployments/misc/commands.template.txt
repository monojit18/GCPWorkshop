https://cloud.google.com/sdk/docs/install-sdk

cd ./google-cloud-sdk
gcloud components update
./install.sh
./install.sh --help
gcloud init

gcloud iam service-accounts list

gcloud iam service-accounts create gke-workshop-sa \
--description="gke workshop sa" --display-name="gke-workshop-sa"

gcloud projects add-iam-policy-binding gke-workshop-cluster \
    --member="serviceAccount:gke-workshop-sa@gke-workshop-cluster.iam.gserviceaccount.com" \
    --role="roles/artifactregistry.writer"

gcloud compute regions list

gcloud container get-server-config --flatten="channels" --filter="channels.channel=REGULAR" \
--region=asia-east1-a --format="yaml(channels.channel,channels.defaultVersion)"

gcloud container clusters create hello-cluster --num-nodes=1
gcloud container clusters get-credentials hello-cluster
#gcloud container clusters delete hello-cluster



gcloud compute networks create gke-workshop-vnet --subnet-mode=custom --bgp-routing-mode=regional
gcloud compute networks list
gcloud compute firewall-rules create gke-workshop-fw --network gke-workshop-vnet --allow tcp,udp,icmp
gcloud compute networks describe gke-workshop-vnet

gcloud compute networks subnets create gke-cluster-subnet --network=gke-workshop-vnet \
--range=11.0.0.0/24 --region=asia-east1
gcloud compute networks subnets list --network=gke-workshop-vnet

gcloud compute networks subnets update gke-cluster-subnet  --region=asia-east1 \
--add-secondary-ranges pod-range=11.0.1.0/24,service-range=11.0.2.0/24

gcloud compute networks subnets describe gke-cluster-subnet  --region=asia-east1
#gcloud compute networks subnets delete gke-cluster-subnet --region=asia-east1

gcloud container clusters create gke-workshop-cluster \
    --region=asia-east1 --enable-ip-alias \
    --network gke-workshop-vnet --subnetwork=gke-cluster-subnet \
    --cluster-secondary-range-name=pod-range --services-secondary-range-name=service-range \
    --node-locations=asia-east1-a --num-nodes=2 --default-max-pods-per-node 60

#gcloud container clusters delete gke-workshop-cluster

gcloud container clusters create gke-workshop-cluster \
    --zone=asia-east1-a --num-nodes=3
gcloud container clusters update gke-workshop-cluster --update-addons=HttpLoadBalancing=ENABLED --region=asia-east1
#gcloud container clusters update gke-workshop-cluster --update-addons=HttpLoadBalancing=DISABLED --region=asia-east1

gcloud container clusters get-credentials gke-workshop-cluster --region=asia-east1

helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install nginx-ingess ingress-nginx/ingress-nginx --namespace nginx-ingess-ns \
--set controller.replicaCount=2 --create-namespace

kubectl create secret docker-registry gkewkshpacr-secret --docker-server= --docker-username= --docker-password=
k create secret generic logicapp-secret --from-literal=AzureWebJobsStorage=""
k create secret generic logicapp-callback-secret --from-literal=LOGICAPP_CALLBACK_URL=""

#az connectedk8s connect --name gke-arc-cluster --resource-group arc-k8s-rg
#gcloud container clusters delete gke-workshop-cluster --region asia-east1 --quiet


sudo usermod -a -G docker ${USER}
docker run --rm busybox date

gcloud artifacts repositories create gcp-workshop-registry --repository-format docker --location asia-east1
gcloud artifacts repositories list
gcloud auth configure-docker asia-east1-docker.pkg.dev

docker tag busybox:latest asia-east1-docker.pkg.dev/gke-workshop-cluster/gcp-workshop-registry/busybox:latest
docker push asia-east1-docker.pkg.dev/gke-workshop-cluster/gcp-workshop-registry/busybox:latest

#gcloud artifacts repositories delete gcp-workshop-registry --location asia-east1

k apply -f ./microservices/hello-world-v1.yaml
k apply -f ./microservices/hello-world-v2.yaml
k apply -f ./ingress/hello-ingress.yaml
